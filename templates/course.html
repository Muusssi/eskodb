{% extends esko_template.html %}

{% block title_block %}tulokset {{ course }}{% end %}

{% block head %}
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src={{static_url("sorttable.js")}}></script>
  <script type="text/javascript">
    var holes = {{holes}};

    var pars = [];
    var course_par = null;

    window.onload = function() {
      var table_head = document.getElementById('result_head');
      var row = table_head.insertRow(1);
      row.insertCell(0);
      row.insertCell(1).outerHTML = "<th>par</th>";
      row.insertCell(2).outerHTML = "<th>{{par_sum}}</th>";
      {% for par in reversed(pars) %}
        pars.push({{par}});
        row.insertCell(2).outerHTML = "<th>{{par}}</th>";
      {% end %}
      course_par = pars.reduce(function(a, b) { return a + b; }, 0);
      pars.reverse();

      filter();

    }

    function mode(array) {
      //array.sort();
      console.log(array);
      if(array.length == 0)
          return null;
      var modeMap = {};
      var maxEl = array[0], maxCount = 1;
      for(var i = 0; i < array.length; i++) {
        var el = array[i];
        if(modeMap[el] == null)
            modeMap[el] = 1;
        else
            modeMap[el]++;

        if(modeMap[el] > maxCount || (modeMap[el] >= maxCount && el > maxEl)) {
            console.log(el);
            maxEl = el;
            maxCount = modeMap[el];
        }
      }
      console.log(maxEl);
      return maxEl;
    }


    function filter() {
      var date_filter = document.getElementById("date_filter").value;
      var player_filter = document.getElementById("player_filter").value.toLowerCase();
      var table = document.getElementById("tbody");
      var Nrows = 0;
      var filtered_rows = [];
      var exact_matchin = true;
      if (player_filter.endsWith(" ")) {
        exact_matchin = false;
        player_filter = player_filter.substring(0,player_filter.length-1);
      }

      // Filter
      for (var i = 0; i < table.rows.length; i++) {
        if (exact_matchin) {
          var not_filtered = (
            (table.rows[i].cells[0].innerHTML.replace(/\s+/g, '').toLowerCase().indexOf(date_filter) == 0 || date_filter == "") &&
            (table.rows[i].cells[1].innerHTML.toLowerCase() == player_filter || player_filter == ""));
        }
        else {
          var not_filtered = (
            (table.rows[i].cells[0].innerHTML.replace(/\s+/g, '').toLowerCase().indexOf(date_filter) == 0 || date_filter == "") &&
            (table.rows[i].cells[1].innerHTML.toLowerCase().indexOf(player_filter) == 0 || player_filter == ""));
        }
        if (not_filtered){
          table.rows[i].hidden = false;
          for (var hole = 1; hole <= holes; hole++) {
            if (filtered_rows[hole-1] == null) {
              filtered_rows[hole-1] = [];
            }
            var throws = parseInt(table.rows[i].cells[hole+1].innerHTML);
            filtered_rows[hole-1].push(throws);
          }
          Nrows++;
        }
        else {
          table.rows[i].hidden = true;
        }
      }

      var avg_row = document.getElementById("avg_row");
      var min_row = document.getElementById("min_row");
      var mode_row = document.getElementById("mode_row");
      var avg_sum = 0;
      var mode_sum = 0;
      var min_sum = 0;
      for (var hole = 1; hole <= holes; hole++) {
        var avg = filtered_rows[hole-1].reduce(function(a, b) { return a + b; }, 0).toFixed(2);
        avg_row.cells[hole+1].innerHTML = (avg/Nrows).toFixed(2);
        avg_row.cells[hole+1].className = "par"+(Math.round(avg/Nrows)-pars[hole-1]);
        avg_sum += avg/Nrows;
        var mod = mode(filtered_rows[hole-1]);
        mode_row.cells[hole+1].innerHTML = mod;
        mode_row.cells[hole+1].className = "par"+(mod-pars[hole-1]);
        mode_sum += mod;
        var min = Math.min(...filtered_rows[hole-1]);
        min_row.cells[hole+1].innerHTML = min;
        min_row.cells[hole+1].className = "par"+(min-pars[hole-1]);
        min_sum += min;
      }
      min_row.cells[holes+2].innerHTML = min_sum;
      min_row.cells[holes+3].innerHTML = min_sum - course_par;
      avg_row.cells[holes+2].innerHTML = avg_sum.toFixed(2);
      avg_row.cells[holes+3].innerHTML = (avg_sum - course_par).toFixed(2);
      mode_row.cells[holes+2].innerHTML = mode_sum;
      mode_row.cells[holes+3].innerHTML = mode_sum - course_par;
    }




  </script>
{% end %}

{% block body %}
  <h1>{{ course }}
    <a class="btn btn-info" href="/full/{{course_id}}/">Lisää koko pelin tulos</a>
    <a class="btn btn-info" href="/hole_statistics/{{course_id}}/1/">Histogrammi</a>
  </h1>

  <p id="loading_message"></p>
  <div id="table_div">
  <label for="date_filter">Filter date:</label>
  <input type="text" id="date_filter" oninput="filter();" value="{{selected_game_date}}">
  <label for="player_filter">Filter player:</label>
  <input type="text" id="player_filter" oninput="filter();" list="players" value="{{selected_player}}">
  <datalist id="players">
    {% for (player, ) in players %}
      <option value="{{player}}">
    {% end %}
  </datalist>

    <table id="foo_tabel" class="sortable table table-striped table-bordered table-condensed table-hover">
      <thead id="result_head">
        <tr>
          <th>Date</th>
          <th>Player</th>
          {% for hole in range(1, holes+1) %}
            <th>{{hole}}</th>
          {% end %}
          <th>Sum</th>
          <th>par</th>
        </tr>

      </thead>
      <tbody id="tbody">

      {% for game, player, row, sum, sum_par in results %}
        <tr>
          <td>{{game}}</td>
          <td>{{player}}</td>
          {% for throws, penalty, dif in row %}
              <td class="par{{dif}}" value="{{throws}}">{{str(throws)+ '*'*penalty}}</td>
          {% end %}
          <td>{{sum}}</td>
          <td>{{sum_par}}</td>
        </tr>
      {% end %}

      </tbody>
      <tfoot id="footer">
        <tr id="min_row">
          <td></td>
          <td>Min:</td>
          {% for _ in range(1, holes+1) %}
            <th></th>
          {% end %}
          <th></th>
          <th></th>
        </tr>
        <tr id="mode_row">
          <td></td>
          <td>Mode:</td>
          {% for _ in range(1, holes+1) %}
            <th></th>
          {% end %}
          <th></th>
          <th></th>
        </tr>
        <tr id="avg_row">
          <td></td>
          <td>Avg:</td>
          {% for _ in range(1, holes+1) %}
            <th></th>
          {% end %}
          <th></th>
          <th></th>
        </tr>
      </tfoot>
    </table>

  </div>
{% end %}